<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FB Bình Chọn Tracker Pro</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            fb: '#1877f2',
            fblight: '#e7f3ff',
            grayfb: '#65676b',
          },
          fontFamily: {
            sans: ['Roboto', 'sans-serif'],
          },
        },
      },
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
</head>
<body class="bg-gray-100 font-sans text-gray-900 flex flex-col h-screen">

  <!-- Tabs -->
  <div class="bg-white border-b border-gray-300 flex shadow-md">
    <button class="tab-btn active px-8 py-3 font-medium text-sm text-gray-600 hover:text-fb transition border-b-4 border-fb" data-tab="realtime">
      Realtime Comments
    </button>
    <button class="tab-btn px-8 py-3 font-medium text-sm text-gray-600 hover:text-fb transition border-b-4 border-transparent" data-tab="search">
      Tìm Kiếm Từ Khóa
    </button>
  </div>

  <!-- Main Layout -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Left: Realtime + Search -->
    <div class="flex-1 flex flex-col bg-white shadow-lg overflow-hidden">
      <!-- Realtime Tab -->
      <div id="realtime" class="tab-content flex flex-col h-full">
        <div class="bg-white border-b border-gray-200 px-6 py-3 sticky top-0 z-10 shadow-sm">
          <h2 class="text-base font-semibold text-gray-800">Realtime Comments</h2>
        </div>
        <div id="comments-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
      </div>

      <!-- Search Tab -->
      <div id="search" class="tab-content hidden flex flex-col h-full">
        <div class="bg-gray-50 border-b border-gray-200 p-5 text-center">
          <input
            type="text"
            id="keyword-input"
            class="w-80 px-4 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:border-fb transition"
            placeholder="Nhập từ khóa (ví dụ: 01, vote, SBD 05, đẹp trai...)"
          />
          <button onclick="searchKeyword()" class="ml-3 px-6 py-2 bg-fb hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition shadow">
            Tìm Kiếm
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-6">
          <div id="search-result" class="text-center text-gray-600"></div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar: Top Bình Chọn -->
    <div class="w-96 bg-white shadow-lg border-l border-gray-200 flex flex-col">
      <div class="bg-white border-b border-gray-200 px-6 py-3 sticky top-0 z-10 shadow-sm">
        <h2 class="text-base font-semibold text-gray-800">Top Bình Chọn</h2>
      </div>
      <div id="trends-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
    </div>
  </div>

  <script>
    const socket = io();
    const commentsList = document.getElementById('comments-list');
    const trendsList = document.getElementById('trends-list');
    const searchResult = document.getElementById('search-result');
    const keywordInput = document.getElementById('keyword-input');

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(t => {
          t.classList.remove('active', 'text-fb', 'border-fb');
          t.classList.add('text-gray-600', 'border-transparent');
        });
        btn.classList.add('active', 'text-fb', 'border-fb');
        btn.classList.remove('text-gray-600', 'border-transparent');

        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(btn.dataset.tab).classList.remove('hidden');
      });
    });

    // Load lịch sử comment khi mở trang
    socket.on('loadHistoryComments', (history) => {
      commentsList.innerHTML = ''; // Xóa cũ nếu có

      history.forEach(data => {
        const div = document.createElement('div');
        div.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
        const firstLetter = data.user[0]?.toUpperCase() || '?';

        div.innerHTML = `
          <div class="flex gap-3">
            <div class="w-10 h-10 rounded-full bg-fblight flex items-center justify-center text-fb font-bold text-sm flex-shrink-0">
              ${firstLetter}
            </div>
            <div class="flex-1">
              <div class="font-medium text-fb text-sm">${data.user}</div>
              <div class="mt-1 text-gray-800 text-sm whitespace-pre-wrap break-words leading-relaxed">${data.comment.replace(/\n/g, '<br>')}</div>
              <div class="mt-2 text-xs text-grayfb">[${data.time}] (lịch sử)</div>
            </div>
          </div>
        `;
        commentsList.prepend(div);
      });
    });

    // Comment mới realtime
    socket.on('newComment', (data) => {
      const div = document.createElement('div');
      div.className = 'bg-blue-50 border-l-4 border-fb p-4 rounded-r-lg shadow-sm';
      const firstLetter = data.user[0]?.toUpperCase() || '?';

      div.innerHTML = `
        <div class="flex gap-3">
          <div class="w-10 h-10 rounded-full bg-fblight flex items-center justify-center text-fb font-bold text-sm flex-shrink-0">
            ${firstLetter}
          </div>
          <div class="flex-1">
            <div class="font-medium text-fb text-sm">${data.user}</div>
            <div class="mt-1 text-gray-800 text-sm whitespace-pre-wrap break-words leading-relaxed">${data.comment.replace(/\n/g, '<br>')}</div>
            <div class="mt-2 text-xs text-grayfb">[${data.time}]</div>
          </div>
        </div>
      `;

      commentsList.prepend(div);

      setTimeout(() => {
        div.classList.remove('bg-blue-50', 'border-l-4', 'border-fb');
        div.classList.add('bg-white');
      }, 3000);

      if (commentsList.children.length > 500) {
        commentsList.removeChild(commentsList.lastChild);
      }
    });

    // Update Top Bình Chọn
    socket.on('updateTrends', (trends) => {
      trendsList.innerHTML = '';
      if (trends.length === 0) {
        trendsList.innerHTML = '<p class="text-center text-gray-500 mt-16 text-sm">Chưa có bình chọn lặp lại nào</p>';
        return;
      }

      trendsList.innerHTML = `<p class="text-center text-gray-500 text-xs mb-4 px-4">Tổng ${trends.length} mẫu bình chọn phổ biến</p>`;
      console.log('Updating trends:', trends);
      trends.forEach((t, i) => {
        const div = document.createElement('div');
        div.className = 'bg-gray-50 hover:bg-gray-100 rounded-lg p-4 shadow transition hover:shadow-md';
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-xl font-bold text-gray-400 w-12 text-center">${i + 1}</div>
            <div class="flex-1 mx-3 font-medium text-gray-800 truncate text-sm">${t.phrase}</div>
            <div class="bg-fblight text-fb font-bold text-lg px-5 py-2 rounded-full">${t.count} lượt</div>
          </div>
        `;
        trendsList.appendChild(div);
      });
    });

    // Tìm kiếm từ khóa
    function searchKeyword() {
      const val = keywordInput.value.trim();
      if (!val) return alert('Vui lòng nhập từ khóa!');
      socket.emit('searchKeyword', val);
      searchResult.innerHTML = '<p class="text-gray-600 text-sm">Đang tìm kiếm...</p>';
    }

    socket.on('searchResult', (data) => {
      if (data.total === 0) {
        searchResult.innerHTML = `<p class="text-gray-600 text-sm">Không tìm thấy comment nào chứa "<strong class="text-fb">${data.keyword}</strong>".</p>`;
        return;
      }

      let html = `<div class="text-center mb-8">
        <div class="text-xl font-bold text-fb">Tổng: ${data.total} comment chứa "${data.keyword}"</div>
      </div>`;

      data.results.forEach(r => {
        html += `
          <div class="bg-white rounded-lg shadow p-4 mb-3 flex justify-between items-center hover:shadow-md transition">
            <div class="flex-1 mr-4">
              <p class="font-medium text-gray-800 text-sm break-words">"${r.comment}"</p>
            </div>
            <div class="bg-fblight text-fb font-bold text-lg px-5 py-2 rounded-full">${r.count} lượt</div>
          </div>
        `;
      });

      searchResult.innerHTML = html;
    });

    keywordInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') searchKeyword();
    });
  </script>
</body>
</html>